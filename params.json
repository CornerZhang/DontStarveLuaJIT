{
  "name": "Dontstarveluajit",
  "tagline": "LuaJIT for DontStarve (compatible with DS, RoG, SW, DST)",
  "body": "# DontStarveLuaJIT for Windows\r\n\tLuaJIT for DontStarve (compatible with DS, RoG, SW, DST)\r\n\r\n\tTested revisions（已测试版本）:  v181038-v181319 WIN32_STEAM\r\n\r\n####  The first test version of DontStarveLuaJIT for Windows \r\n\r\n####  这是DontStarveLuaJIT For Windows 的第一个测试版本！\r\n\r\n####  PLEASE BACKUP YOUR SAVES BEFORE APPLYING THIS PATCH. \r\n\r\n####  在启用这个补丁之前，请务必备份你的所有存档。\r\n\r\n\r\n##Installation（安装）: \r\n\r\n##### Step 1:\r\n\tCopy all files from \"DontStarveLuaJIT/bin/\" to \"[Your Don't Starve Directory]/bin/\"\r\n\r\n\t复制\"DontStarveLuaJIT/bin/\"目录下的所有文件至\"[您的Don't Starve安装目录]/bin/\"\r\n\r\n##### Step 2:\t\r\n\tOpen \"[Your Don't Starve Directory]/data/scripts/mods.lua\" with an text editor. Locate the following lines:\r\n\r\n\t使用文本编辑器打开“[您的Don't Starve安装目录]/data/scripts/mods.lua”文件。定位到如下代码行：\r\n\r\n```lua\r\nlocal runmodfn = function(fn,mod,modtype)\r\n\treturn (function(...)\r\n\t\tif fn then\r\n\t\t\tlocal arg = {...} --<<<<\r\n\t\t\tlocal status, r = xpcall( function() return fn(unpack(arg)) end, debug.traceback)\r\n\t\t\tif not status then\r\n\t\t\t\tprint(\"error calling \"..modtype..\" in mod \"..ModInfoname(mod.modname)..\": \\n\"..r)\r\n\t\t\t\tModManager:RemoveBadMod(mod.modname,r)\r\n\t\t\t\tModManager:DisplayBadMods()\r\n\t\t\telse\r\n\t\t\t\treturn r\r\n\t\t\tend\r\n\t\tend\r\n\tend)\r\nend\r\n```\r\n\tAdd one line at --<<<< mark as above.\r\n\r\n\t在-<<<<标记处如上所示添加一行代码。\r\n\r\n\tSave mods.lua. \r\n\r\n\t保存 mods.lua 文件。\r\n\t\r\n\t\r\n\tIf it's DST, open \"[Your Don't Starve Directory]/data/scripts/util.lua\" with an text editor.\r\n\tLocate the following lines:\r\n\r\n\t如果是联机版，还需要使用文本编辑器打开“[您的Don't Starve安装目录]/data/scripts/util.lua”文件。\r\n\t定位到如下代码行：\t\r\n\t\r\n```lua\t\r\n-- return only values found in all arrays\r\nfunction ArrayIntersection(...)\r\n\tlocal ret = {}\r\n    local arg = {...}\r\n\tfor i,val in ipairs(arg[1]) do\r\n\t\tlocal good = true\r\n\t\tfor i=2,#arg do\r\n\t\t\tif not table.contains(arg[i], val) then\r\n\t\t\t\tgood = false\r\n\t\t\t\tbreak\r\n\t\t\tend\r\n\t\tend\r\n\t\tif good then\r\n\t\t\ttable.insert(ret, val)\r\n\t\tend\r\n\tend\r\n\treturn ret\r\nend\t\r\n```\r\n\tAdd one line at --<<<< mark as above.\r\n\r\n\t在-<<<<标记处如上所示添加一行代码。\r\n\r\n\tSave util.lua. \r\n\r\n\t保存 util.lua 文件。\r\n\t\r\n##### Step 3:\t\r\n\tOpen \"[Your Don't Starve Directory]/data/scripts/modutil.lua\" with an text editor. \r\n\t\r\n\tReplace all 'arg = {...}' with 'local arg = {...}' (quote mark not included)\r\n\r\n\t使用文本编辑器打开“[您的Don't Starve安装目录]/data/scripts/modutil.lua”文件。\r\n\t\r\n\t将所有的'arg = {...}'替换为'local arg = {...}' （不包含引号）\r\n\r\n##### BTW...\r\n\r\n\tThe reason for modification: Official lua distribution 5.1.4+ and LuaJIT refined the concept of variant\r\n\targuments so grammar sugar 'arg' was no longer supported. Lua programmers should use {...} instead. The\r\n\tdevelopers of Don't Starve obeyed the rules except 'mods.lua' because '...' cannot be passed across closure\r\n\tboundary. So they simply wrote 'arg', which leads to runtime error in LuaJIT and advanced lua engines, \r\n\tsince 'arg' is reinterpreted as a global variable (but it's nil). Now we must declare 'arg' manually.\r\n\r\n\t这样修改的原因是：Lua官方所发布的新版lua以及LuaJIT修正了不定长参数的概念，现在lua不再支持'arg'这个\r\n\t语法糖来表示不定参数的列表。Lua程序员如果需要，可以显式地使用{...}来代替它。\r\n\t\r\n\tDon't Starve的开发者在绝大多数情况下都遵守了这个变动。然而，在mods.lua中，他们发现'...'表示的不定参数\r\n\t不能穿越闭包边界，因此使用了旧的用法。现在我们需要手动定义'arg'，以保证程序可以正确执行。\r\n\r\n#### NOTICE:\r\n\r\n\tNOTICE: Some mods, for example, 'Smart Craft Pot', are still using 'arg' in its code, which leads to\r\n\tcrash when player activates related function. Here's an example for fixing it (take 'Smart Craft Pot' as example).\r\n\r\n\t注意：有些MOD，例如'Smart Craft Pot'，也使用了旧式的'arg'语法。当用户触发了含有这种语法的函数时，\r\n\t游戏将崩溃。以'Smart Craft Pot'为例，我们也需要修复它：\r\n\r\n \tOpen \"Steam/SteamApps/common/dont_starve/mods/workshop-662872357/scripts/widgets/foodcrafting.lua\" with\r\n \tan text editor. Locate the following lines (in fact, the file:line of crashing will be displayed in Don't\r\n \tStarve crash screen):\r\n\r\n\t使用文本编辑器打开“Steam/SteamApps/common/dont_starve/mods/workshop-662872357/scripts/widgets/foodcrafting.lua”\r\n\t文件，定位到如下代码行（实际上，崩溃的文件：行号在崩溃的时候会显示在Don't Starve 的崩溃界面上，很容易找）：\r\n\r\n```lua\r\nfunction FoodCrafting:_GetContainerIngredients(...)\r\n\tlocal ings = {}\r\n\r\n\t-- for _,container in ipairs(arg) do -- >>>\r\n\tfor _,container in ipairs({...}) do -- <<<\r\n\t\tlocal slots = container.slots or container.itemslots or {}\r\n\r\n  \tfor k,v in pairs(slots) do\r\n\t\t\tlocal amt = v.components.stackable and v.components.stackable.stacksize or 1\r\n    \ttable.insert(ings, {name=v.prefab,amt=amt})\r\n  \tend\r\n\tend\r\n  return ings\r\nend\r\n```\r\n\r\n\tModify code as above.\r\n\r\n\t如上所示修改即可。\r\n\r\n##Build（生成）: \r\n\r\n\tThe project 'lua51' in solution must be compiled under MSVC9 (Visual Studio 2008) to generate \r\n\tbinary-compatible code for dontstarve_steam.exe. To compile luajit, please launch Visual C++ \r\n\tBuild Prompt and run msvcbuild.bat.\r\n\r\n\t为确保与饥荒主程序的二进制兼容性，解决方案中的lua51必须使用MSVC9（即VS2008）来编译。\r\n\t如果您要自行编译luajit，请在Visual C++的控制台中运行luajit目录下的msvcbuild.bat。\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}