<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Dontstarveluajit by paintdream</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Dontstarveluajit</h1>
      <h2 class="project-tagline">LuaJIT for DontStarve (compatible with DS, RoG, SW, DST)</h2>
      <a href="https://github.com/paintdream/DontStarveLuaJIT" class="btn">View on GitHub</a>
      <a href="https://github.com/paintdream/DontStarveLuaJIT/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/paintdream/DontStarveLuaJIT/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="dontstarveluajit-for-windows" class="anchor" href="#dontstarveluajit-for-windows" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DontStarveLuaJIT for Windows</h1>

<pre><code>LuaJIT for DontStarve (compatible with DS, RoG, SW, DST)

Tested revisions（已测试版本）:  v181038-v181319 WIN32_STEAM
</code></pre>

<h4>
<a id="the-first-test-version-of-dontstarveluajit-for-windows" class="anchor" href="#the-first-test-version-of-dontstarveluajit-for-windows" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>The first test version of DontStarveLuaJIT for Windows</h4>

<h4>
<a id="这是dontstarveluajit-for-windows-的第一个测试版本" class="anchor" href="#%E8%BF%99%E6%98%AFdontstarveluajit-for-windows-%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95%E7%89%88%E6%9C%AC" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>这是DontStarveLuaJIT For Windows 的第一个测试版本！</h4>

<h4>
<a id="please-backup-your-saves-before-applying-this-patch" class="anchor" href="#please-backup-your-saves-before-applying-this-patch" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>PLEASE BACKUP YOUR SAVES BEFORE APPLYING THIS PATCH.</h4>

<h4>
<a id="在启用这个补丁之前请务必备份你的所有存档" class="anchor" href="#%E5%9C%A8%E5%90%AF%E7%94%A8%E8%BF%99%E4%B8%AA%E8%A1%A5%E4%B8%81%E4%B9%8B%E5%89%8D%E8%AF%B7%E5%8A%A1%E5%BF%85%E5%A4%87%E4%BB%BD%E4%BD%A0%E7%9A%84%E6%89%80%E6%9C%89%E5%AD%98%E6%A1%A3" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>在启用这个补丁之前，请务必备份你的所有存档。</h4>

<h4>
<a id="you-must-have-this-mod-installed-on-both-server-and-client-for-dont-starve-together" class="anchor" href="#you-must-have-this-mod-installed-on-both-server-and-client-for-dont-starve-together" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>YOU MUST HAVE THIS MOD INSTALLED ON BOTH SERVER AND CLIENT FOR DON'T STARVE TOGETHER!</h4>

<h4>
<a id="如果您打算将这个mod安装到联机版本dont-starve-together请确保在客户端和服务端都安装了这个mod" class="anchor" href="#%E5%A6%82%E6%9E%9C%E6%82%A8%E6%89%93%E7%AE%97%E5%B0%86%E8%BF%99%E4%B8%AAmod%E5%AE%89%E8%A3%85%E5%88%B0%E8%81%94%E6%9C%BA%E7%89%88%E6%9C%ACdont-starve-together%E8%AF%B7%E7%A1%AE%E4%BF%9D%E5%9C%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%92%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%83%BD%E5%AE%89%E8%A3%85%E4%BA%86%E8%BF%99%E4%B8%AAmod" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>如果您打算将这个MOD安装到联机版本（Don't Starve Together），请确保在客户端和服务端都安装了这个MOD！</h4>

<hr>

<h5>
<a id="some-saves-created-without-this-patch-cannot-be-loaded-due-to-extra" class="anchor" href="#some-saves-created-without-this-patch-cannot-be-loaded-due-to-extra" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>SOME SAVES CREATED WITHOUT THIS PATCH CANNOT BE LOADED DUE TO EXTRA</h5>

<h5>
<a id="data-written-by-some-mods-using-engine-related-functions-such-as-lua_dump" class="anchor" href="#data-written-by-some-mods-using-engine-related-functions-such-as-lua_dump" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>DATA WRITTEN BY SOME MODS USING ENGINE-RELATED FUNCTIONS (SUCH AS lua_dump).</h5>

<h5>
<a id="these-data-cannot-be-recognized-by-luajit" class="anchor" href="#these-data-cannot-be-recognized-by-luajit" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>THESE DATA CANNOT BE RECOGNIZED BY LUAJIT.</h5>

<h5>
<a id="一些在这个补丁使用之前创建的存档可能无法被正确加载" class="anchor" href="#%E4%B8%80%E4%BA%9B%E5%9C%A8%E8%BF%99%E4%B8%AA%E8%A1%A5%E4%B8%81%E4%BD%BF%E7%94%A8%E4%B9%8B%E5%89%8D%E5%88%9B%E5%BB%BA%E7%9A%84%E5%AD%98%E6%A1%A3%E5%8F%AF%E8%83%BD%E6%97%A0%E6%B3%95%E8%A2%AB%E6%AD%A3%E7%A1%AE%E5%8A%A0%E8%BD%BD" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>一些在这个补丁使用之前创建的存档可能无法被正确加载。</h5>

<h5>
<a id="这是由于一些mods使用了引擎相关的函数向存档内写入了数据" class="anchor" href="#%E8%BF%99%E6%98%AF%E7%94%B1%E4%BA%8E%E4%B8%80%E4%BA%9Bmods%E4%BD%BF%E7%94%A8%E4%BA%86%E5%BC%95%E6%93%8E%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%BD%E6%95%B0%E5%90%91%E5%AD%98%E6%A1%A3%E5%86%85%E5%86%99%E5%85%A5%E4%BA%86%E6%95%B0%E6%8D%AE" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>这是由于一些MODs使用了引擎相关的函数向存档内写入了数据。</h5>

<h5>
<a id="这些数据不能被luajit正确解析" class="anchor" href="#%E8%BF%99%E4%BA%9B%E6%95%B0%E6%8D%AE%E4%B8%8D%E8%83%BD%E8%A2%ABluajit%E6%AD%A3%E7%A1%AE%E8%A7%A3%E6%9E%90" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>这些数据不能被LUAJIT正确解析。</h5>

<hr>

<h2>
<a id="installation安装" class="anchor" href="#installation%E5%AE%89%E8%A3%85" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation（安装）:</h2>

<h5>
<a id="step-1" class="anchor" href="#step-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Step 1:</h5>

<pre><code>Copy all files from "DontStarveLuaJIT/bin/" to "[Your Don't Starve Directory]/bin/"

复制"DontStarveLuaJIT/bin/"目录下的所有文件至"[您的Don't Starve安装目录]/bin/"
</code></pre>

<h5>
<a id="step-2-for-dst仅针对联机版" class="anchor" href="#step-2-for-dst%E4%BB%85%E9%92%88%E5%AF%B9%E8%81%94%E6%9C%BA%E7%89%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Step 2: (FOR DST，仅针对联机版)</h5>

<pre><code>If it's DST, open "[Your Don't Starve Directory]/data/scripts/util.lua" with an text editor.
Locate the following lines:

如果是联机版，还需要使用文本编辑器打开“[您的Don't Starve安装目录]/data/scripts/util.lua”文件。
定位到如下代码行： 
</code></pre>

<div class="highlight highlight-source-lua"><pre><span class="pl-k">function</span> <span class="pl-en">RunInSandboxSafe</span>(<span class="pl-smi">untrusted_code, error_handler</span>)
    error_handler <span class="pl-k">=</span> error_handler <span class="pl-k">or</span> <span class="pl-k">function</span> (str) <span class="pl-c1">print</span>(<span class="pl-s"><span class="pl-pds">"</span>Klei, you have missed this line: <span class="pl-pds">"</span></span> <span class="pl-k">..</span> str) <span class="pl-k">end</span> <span class="pl-c">--&lt;&lt;&lt;&lt;</span>
    <span class="pl-k">if</span> untrusted_code:<span class="pl-c1">byte</span>(<span class="pl-c1">1</span>) <span class="pl-k">==</span> <span class="pl-c1">27</span> <span class="pl-k">then</span> <span class="pl-k">return</span> <span class="pl-c1">nil</span>, <span class="pl-s"><span class="pl-pds">"</span>binary bytecode prohibited<span class="pl-pds">"</span></span> <span class="pl-k">end</span>
    <span class="pl-k">local</span> untrusted_function, message <span class="pl-k">=</span> <span class="pl-c1">loadstring</span>(untrusted_code)
    <span class="pl-k">if</span> <span class="pl-k">not</span> untrusted_function <span class="pl-k">then</span> <span class="pl-k">return</span> <span class="pl-c1">nil</span>, message <span class="pl-k">end</span>
    <span class="pl-c1">setfenv</span>(untrusted_function, {} )
    <span class="pl-k">return</span> <span class="pl-c1">xpcall</span>(untrusted_function, error_handler )
<span class="pl-k">end</span></pre></div>

<pre><code>Add one line at --&lt;&lt;&lt;&lt; mark as above.

在-&lt;&lt;&lt;&lt;标记处如上所示添加一行代码。

Save util.lua. 

保存 util.lua 文件。
</code></pre>

<h5>
<a id="step-3-for-dst仅针对联机版" class="anchor" href="#step-3-for-dst%E4%BB%85%E9%92%88%E5%AF%B9%E8%81%94%E6%9C%BA%E7%89%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Step 3: (FOR DST，仅针对联机版)</h5>

<pre><code>If it's DST, open "[Your Don't Starve Directory]/data/scripts/networkclientrpc.lua" with an text editor.
Locate the following lines (Search 'Generate RPC codes from table of handlers'):

如果是联机版，还需要使用文本编辑器打开“[您的Don't Starve安装目录]/data/scripts/networkclientrpc.lua”文件。
定位到如下代码行（搜索“Generate RPC codes from table of handlers”就能找到）：  
</code></pre>

<div class="highlight highlight-source-lua"><pre><span class="pl-c">--Generate RPC codes from table of handlers</span>

<span class="pl-k">local</span> i <span class="pl-k">=</span> <span class="pl-c1">1</span>
<span class="pl-k">for</span> k, v <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(RPC_HANDLERS) <span class="pl-k">do</span>
    RPC[k] <span class="pl-k">=</span> i
    i <span class="pl-k">=</span> i <span class="pl-k">+</span> <span class="pl-c1">1</span>
<span class="pl-k">end</span>
i <span class="pl-k">=</span> <span class="pl-c1">nil</span></pre></div>

<pre><code>Replace them with:

使用如下的代码替换掉上面的内容：
</code></pre>

<div class="highlight highlight-source-lua"><pre><span class="pl-c">--Generate RPC codes from table of handlers</span>
<span class="pl-k">local</span> temp <span class="pl-k">=</span> {}
<span class="pl-k">for</span> k, v <span class="pl-k">in</span> <span class="pl-c1">pairs</span>(RPC_HANDLERS) <span class="pl-k">do</span>
    <span class="pl-c1">table.insert</span>(temp, k)
<span class="pl-k">end</span>

<span class="pl-c1">table.sort</span>(temp)

<span class="pl-k">for</span> k, v <span class="pl-k">in</span> <span class="pl-c1">ipairs</span>(temp) <span class="pl-k">do</span>
    RPC[v] <span class="pl-k">=</span> k
<span class="pl-k">end</span></pre></div>

<pre><code>Save networkclientrpc.lua. 

保存 networkclientrpc.lua 文件。
</code></pre>

<h2>
<a id="compilation编译" class="anchor" href="#compilation%E7%BC%96%E8%AF%91" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Compilation（编译）:</h2>

<pre><code>The project 'lua51' in solution must be compiled under MSVC9 (Visual Studio 2008) to generate 
binary-compatible code for dontstarve_steam.exe. To compile luajit, please launch Visual C++ 
Build Prompt and run msvcbuild.bat.

为确保与饥荒主程序的二进制兼容性，解决方案中的lua51必须使用MSVC9（即VS2008）来编译。
如果您要自行编译luajit，请在Visual C++的控制台中运行luajit目录下的msvcbuild.bat。

lua51.dll for DST is build from 'lua51' project with predefined macro 'DST'.

向工程lua51添加前置宏定义'DST'可以编译出针对DST版本的lua51.dll。
</code></pre>

<h2>
<a id="acknowledgements致谢" class="anchor" href="#acknowledgements%E8%87%B4%E8%B0%A2" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Acknowledgements（致谢）:</h2>

<pre><code>Great thanks to the following players from Baidu Tieba for testing and suggestions!

感谢百度贴吧以下吧友对于MOD的测试和建议！

风雨凌芸、子恒Clark、359368170、lild100、kkrbdsgc、__PeakChen、o裙下臣o、 LC_1992、
pikry、沉睡森丶林、可待year、绝世鱼人、王太太平、力玄破、渊_雎、风雪归途、幻想草莓梦、
sharpwind95
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/paintdream/DontStarveLuaJIT">Dontstarveluajit</a> is maintained by <a href="https://github.com/paintdream">paintdream</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
